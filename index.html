onValue(ref(db, 'groups'), (snapshot) => {
  const data = snapshot.val() || {};
  const now = Date.now();
  const timeoutMinutes = 5;

  // すでに存在するマーカーをすべてチェック
  for (const groupId in markers) {
    // データが存在しない、または古すぎる場合は削除
    if (!data[groupId] || ((now - (data[groupId].timestamp || 0)) / 60000) > timeoutMinutes) {
      map.removeLayer(markers[groupId]);
      delete markers[groupId];
    }
  }

  // 残っている新しい班の位置を更新
  for (const groupId in data) {
    const { lat, lng, timestamp } = data[groupId];
    const ageMinutes = (now - (timestamp || 0)) / 60000;

    if (ageMinutes <= timeoutMinutes) {
      if (!markers[groupId]) {
        markers[groupId] = L.marker([lat, lng]).addTo(map).bindPopup(groupId);
      } else {
        markers[groupId].setLatLng([lat, lng]);
      }
    }
  }
});
